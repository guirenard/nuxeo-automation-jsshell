<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
     <link class="component" href="/nuxeo/css/jquery.terminal.css" rel="stylesheet" type="text/css" />
     <script type="text/javascript"><!--
var nxthemesPath = "/nuxeo";
var nxthemesBasePath = "/nuxeo/site";
var nxContextPath = "/nuxeo";
//--></script>
     <script type="text/javascript" src="/nuxeo/nxthemes-lib/jquery.js"></script>
     <script type="text/javascript" src="/nuxeo/scripts/automation.js"></script>
     <script type="text/javascript" src="/nuxeo/scripts/jquery.terminal-0.6.3.js"></script>
</head>

<body>

<div id="nxterm"> </div>

<script>

  function nxGreetings() {
    var head = "";
    head+="  _   _                      _____ _          _ _  \n";
    head+=" | \\ | |                    / ____| |        | | | \n";
    head+=" |  \\| |_   ___  _____  ___| (___ | |__   ___| | | \n";
    head+=" | . ` | | | \\ \\/ / _ \\/ _ \\\\___ \\| '_ \\ / _ \\ | | \n";
    head+=" | |\\  | |_| |>  <  __/ (_) |___) | | | |  __/ | | \n";
    head+=" |_| \\_|\\__,_/_/\\_\\___|\\___/_____/|_| |_|\\___|_|_| \n\n\n";
    return head;
  }

  var automationDefs;

  function getAutomationDefs() {
    return automationDefs;
  }

  function fetchAutomationDefs() {
   jQuery.ajax({
        type: 'GET',
        contentType : 'application/json',
        url: "/nuxeo/site/automation",
        success: function(data, status,xhr) {
          if (status=="success") {
            console.log(data);
            automationDefs = data;
          } else {
            console.log("Error, Status =" + status);
          }
        }
      });
  }

  function nxTermHandler(cmd, term) {
     var cmds = cmd.split(" ");

     var op = findOperation(cmds[0]);
     if (op) {
       var opts = {automationParams : { params : {},
           context : {}} };
       for (var i = 1; i < cmds.length; i++) {
         var arg = cmds[i];
         if (arg.indexOf("=")>0) {
           var param = arg.split("=");
           console.log(param);
           opts.automationParams.params[param[0]]=param[1];
         }
       }

       var automation = jQuery().automation(op.id , opts);

       var successCB = function(data, status,xhr) {
         term.echo(data);
       };
       var errorCB = function(xhr,status) {
         term.echo("Error " + status);
       };

       automation.execute(successCB, errorCB);

     }
     console.log(cmd);
     term.echo("noop");
  }

  function findOperation(operationId) {
   for (var idx=0; idx < automationDefs.operations.length; idx++) {
      var op = automationDefs.operations[idx];
      if (op.id===operationId) {
        return op;
      }
    }
    return null;
  }

  function help(op,term) {
    if (op) {
      term.echo(op.id + ":" + op.label);
      term.echo(op.description);
    }
  }

  function completion(term,input,callback) {
    var existingInput = term.get_command().trim()
    console.log("existingInput=", existingInput);
    var op = findOperation(existingInput.split(" ")[0]);
    var suggestions = [];
    if (op) {
     console.log("input = ", input);
     for (var idx=0; idx < op.params.length; idx++) {
       var pName = op.params[idx].name;
       if (existingInput.indexOf(pName + "=")>0) {
         continue;
       }
       if (pName.indexOf(input)==0) {
         suggestions.push(pName + "=");
       }
       callback(suggestions);
     }
    } else {
      var cmd = input.split(" ")[0];
      console.log(input);
      console.log(term.get_command());
      for (var idx=0; idx < automationDefs.operations.length; idx++) {
        var op = automationDefs.operations[idx];
        if (op.id.indexOf(cmd)==0) {
          suggestions.push(op.id);
        }
        if (suggestions.length > 5) {
          break;
        }
      }
     callback(suggestions);
    }
  }

  var termSettings =  {
    prompt: 'nx> ',
    name: 'nxshell',
    greetings : nxGreetings,
    tabcompletion : true,
    completion : completion
  };

  jQuery(document).ready(function() {
     jQuery('#nxterm').terminal(nxTermHandler, termSettings);
     fetchAutomationDefs();
   });

</script>

</body>
</html>